import 'package:supabase_flutter/supabase_flutter.dart';
import '../services/profile_service.dart';

class AuthService {
  AuthService._();
  static final AuthService instance = AuthService._();

  final _client = Supabase.instance.client;
  final _auth = Supabase.instance.client.auth;

  /// ???????? ?????? (?? ???? null)
  User? get currentUser => _auth.currentUser;

  /// ?????? ????? ???? ??????
  Stream<AuthState> get onAuthStateChange => _auth.onAuthStateChange;

  /// ????? ???? ????
  Future<AuthResponse> signUp({
    required String email,
    required String password,
  }) async {
    final res = await _auth.signUp(email: email, password: password);

    // ??? ????? ??????? ???? ?? ?? ??? profile ?????
    final _p = ProfileService();
    await _p.ensureRow();

    return res;
    // ??????: ?? ???? OTP/Email Confirm ????? ?????? ?????? ????? ???.
  }

  /// ????? ??????
  Future<AuthResponse> signIn({
    required String email,
    required String password,
  }) async {
    final res = await _auth.signInWithPassword(email: email, password: password);

    // ???? ???? ?? profile ????????
    final _p = ProfileService();
    await _p.ensureRow();

    return res;
  }

  /// ????? ??????
  Future<void> signOut() async {
    await _auth.signOut();
  }

  /// ??? ????????? ?? ??????? ????????? (????? ???? ?????)
  Future<List<dynamic>> getCommentsForPost(String postId) async {
    final rows = await _client
        .from('comments')
        .select(
            'id, content, user_id, created_at, profiles(username, avatar_url)')
        .eq('post_id', postId)
        .order('created_at');
    return rows;
  }
}